{"config":{"lang":["fr"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Home assistant","text":"<p>Home Assistant est un logiciel domotique open source que j'utilise afin de rendre ma maison \"intelligente\".</p> <p>Je vais vous pr\u00e9senter les principaux sc\u00e9narios d'automatisation que j'utilise au quotidien.</p>"},{"location":"#automatisations","title":"Automatisations","text":"<p>L'objectif est de mettre en place des actions automatiques en r\u00e9ponse \u00e0 des \u00e9v\u00e9nements survenant au sein de la maison.</p> <ul> <li>Allumer des lumi\u00e8res au r\u00e9veil</li> <li>Notification de connexion</li> <li>Rappel arrosage de mon bonsai</li> <li>Trajet domicile/travail</li> <li>T\u00e9l\u00e9vision</li> <li>Mode nuit</li> </ul>"},{"location":"#mes-sources-dinspiration","title":"Mes sources d'inspiration","text":"<ul> <li>The Anchorage House Home Assistant Configuration</li> <li>Isabella Gross Alstr\u00f6m Home Assistant Configuration</li> </ul>"},{"location":"01-reveil/","title":"R\u00e9veil","text":"<p>Objectif</p> <p>Allumer 2 lampes \u00e0 l'heure du r\u00e9veil.</p>"},{"location":"01-reveil/#materiel-utilise","title":"Mat\u00e9riel utilis\u00e9","text":"<ul> <li>2 ampoules de marque Wiz positionn\u00e9es dans le salon et la salle \u00e0 manger</li> <li>1 t\u00e9l\u00e9phone portable sur lequel est install\u00e9e l'application mobile Home assistant pour r\u00e9cup\u00e9rer l'heure de la prochaine alarme (heure de r\u00e9veil).</li> </ul>"},{"location":"01-reveil/#mise-en-oeuvre","title":"Mise en oeuvre","text":"<p>Les ampoules de la marque Wiz peuvent \u00eatre int\u00e9gr\u00e9es automatiquement dans Home Assistant avec l'int\u00e9gration Wiz.</p>"},{"location":"01-reveil/#script-reveil","title":"Script r\u00e9veil","text":"<p>Permet d'allumer les ampoules et de r\u00e9gler puissance et temp\u00e9rature.</p> <pre><code>scripts:\nreveil:\nalias: reveil\nsequence:\n- service: light.turn_on\ndata:\nbrightness: 80\ncolor_temp: 1000000\nentity_id: light.salle_a_manger\n- service: light.turn_on\ndata: {}\nentity_id: light.salon\nmode: single\nicon: mdi:alarm\n</code></pre>"},{"location":"01-reveil/#automation","title":"Automation","text":"<p>L'automation se base sur l'heure  de la prochaine alarme remont\u00e9e par l'application mobile  :  sensor.pixel_2_xl_next_alarm.</p> <p>Le script reveil est appel\u00e9 quand l'heure de reveil est atteinte si le mode vacance n'a pas \u00e9t\u00e9 activ\u00e9.</p> <pre><code>automation:\n- id: lumierereveil\nalias: allumer lumi\u00e8res au r\u00e9veil\ntrigger:\n- platform: template\nvalue_template: &gt;\n{{now().strftime(\"%a %h %d %H:%M %Z %Y\") == (((state_attr('sensor.pixel_2_xl_next_alarm', 'Time in Milliseconds') | int / 1000) + 0*60 ) | timestamp_custom('%a %h %d %H:%M %Z %Y'))}}\ncondition:\n- condition: state\nentity_id: input_boolean.mode_vacance\nstate: 'off'\n\naction:\n- service: script.reveil\n</code></pre>"},{"location":"02-ssh-login-notification/","title":"Notification de connexion","text":"<p>Objectif</p> <p>Envoyer une notification lors d'une connexion en ssh sur mon serveur NAS.</p>"},{"location":"02-ssh-login-notification/#materiel-utilise","title":"Mat\u00e9riel utilis\u00e9","text":"<ul> <li>1 serveur NAS permettant la connexion distante par ssh</li> <li>1 t\u00e9l\u00e9phone portable sur lequel est install\u00e9e l'application mobile Home assistant pour recevoir la notification.</li> </ul>"},{"location":"02-ssh-login-notification/#mise-en-oeuvre","title":"Mise en oeuvre","text":"<p>Lors d'une connexion ssh les commandes pr\u00e9sentes dans le fichier /etc/ssh/sshrc sont ex\u00e9cut\u00e9es. En ajoutant les lignes de commandes suivantes il est possible d'appeler un WEBHOOK au niveau de Home Assistant.</p>"},{"location":"02-ssh-login-notification/#sshrc","title":"sshrc","text":"<pre><code>#!/bin/bash\n\nip=$(echo \"$SSH_CONNECTION\" | cut -d \" \" -f 1)\nhs=$(hostname)\n\nhostIP=\"$(ip address show dev eth0 | grep \"inet \" | head --lines=1 | cut --delimiter=' ' --fields=6 | cut --delimiter='/' --fields=1)\"\n\nlogger -t ssh-wrapper \"$USER\" login from \"$ip\"\n\ncurl --header \"Content-Type: application/json\" \\\n--request POST \\\n--data \\\n'{\"topic\": \"'\"$hs\"'\",\n \"host\": \"'\"$hs\"'\",\n \"hostIP\": \"'\"$hostIP\"'\",\n \"user\": \"'\"$USER\"'\",\n \"from\": \"'\"$ip\"'\",\n \"message\": \"'\"$USER@$hs just logged in from $ip\"'\"}' \\\nhttp://localhost:8123/api/webhook/MY-SSH-WEBHOOK\n</code></pre> <p>La derni\u00e8re ligne doit \u00eatre adapt\u00e9e avec l'adresse de votre instance Home Assistant. Dans mon cas, elle est situ\u00e9e sur la m\u00eame machine.</p>"},{"location":"02-ssh-login-notification/#traitement-du-webhook","title":"Traitement du WEBHOOK","text":"<p>A la r\u00e9ception du WEBHOOK, le sensor ssh_login prend la valeur du message envoy\u00e9 (bob@nas just logged in from 192.168.1.2 par exemple).</p> <p>Au changement de valeur du sensor ssh_login, le service de notification est appel\u00e9 avec le message stock\u00e9 sur le sensor.</p> <pre><code>automation:\n- id: ssh_login_notify\nalias: notify nas ssh login\ntrigger:\n- platform: state\nentity_id: sensor.ssh_login\naction:\nservice: notify.mobile_app_pixel_2_xl\ndata:\nmessage: '{{ states.sensor.ssh_login.state }}'\n\ntemplate:\n- trigger:\n- platform: webhook\nwebhook_id: MY-SSH-WEBHOOK\nsensor:\n- name: \"ssh_login\"\nstate: \"{{ trigger.json.message }}\"\n</code></pre>"},{"location":"03-bonsai/","title":"Arrosage","text":"<p>Objectif</p> <p>Se rappeler de la date du dernier arrosage de mon bonsai en scannant un tag NFC pr\u00e9sent dans la soucoupe et envoyer une notification de rappel quand la date de prochain arrosage est atteinte.</p>"},{"location":"03-bonsai/#materiel-utilise","title":"Mat\u00e9riel utilis\u00e9","text":"<ul> <li>1 badge NFC pouvant \u00eatre \u00e9crit par Home Assistant</li> <li>1 t\u00e9l\u00e9phone portable sur lequel est install\u00e9e l'application mobile Home assistant pour recevoir la notification.</li> </ul>"},{"location":"03-bonsai/#mise-en-oeuvre","title":"Mise en oeuvre","text":""},{"location":"03-bonsai/#parametrage-du-delai-entre-deux-arrosages","title":"Param\u00e9trage du d\u00e9lai entre deux arrosages","text":"<pre><code>input_number:\ninterval_arrosage:\nname: Interval en jour entre 2 arrosages initial: 3\nmin: 1\nmax: 7\nstep: 1\nmode: box\n</code></pre>"},{"location":"03-bonsai/#date-dernierprochain-arrosage","title":"Date dernier/prochain arrosage","text":"<pre><code>input_datetime:\ndate_arrosage:\nname: date dernier arrosage\nhas_date: true\nhas_time: false\ndate_next_arrosage:\nname: date prochain arrosage\nhas_date: true\nhas_time: false\n</code></pre>"},{"location":"03-bonsai/#lecture-du-badge-nfc","title":"Lecture du badge NFC","text":"<pre><code>automation:\n- id: 'update_date_arrosage'\nalias: La balise bonsai est analys\u00e9e\ndescription: ''\ntrigger:\n- platform: tag\ntag_id: 2fbab09d-6347-4042-8165-1a35c0877a7f\ncondition: []\naction:\n- service: input_datetime.set_datetime\ndata:\ndatetime: \"{{ now().strftime('%Y-%m-%d') }}\"\nentity_id: input_datetime.date_arrosage\n- service: input_datetime.set_datetime\ndata:\ndatetime: \"{{ (now() + timedelta(days=states('input_number.interval_arrosage')| int + 1)).strftime('%Y-%m-%d') }}\"\nentity_id: input_datetime.date_next_arrosage\nmode: single\n</code></pre>"},{"location":"03-bonsai/#notification","title":"Notification","text":"<pre><code>automation:\n- id: 'rappelArrosage'\nalias: rappel arrosage Bonsai\ntrigger:\n- platform: time\nat: \"17:00:00\"\ncondition:\n- condition: state\nentity_id: input_boolean.mode_vacance\nstate: 'off'\n- condition: template\nvalue_template: \"{{ states('sensor.date') &gt; states('input_datetime.date_next_arrosage') }}\"\naction:\n- service: notify.mobile_app_pixel_2_xl\ndata:\nmessage: 'Il est temps d'arroser le Bonsai'\n- service: input_datetime.set_datetime\ndata:\ndatetime: \"{{ (now() + timedelta(days=1)).strftime('%Y-%m-%d') }}\"\nentity_id: input_datetime.date_next_arrosage\n</code></pre>"},{"location":"03-bonsai/#interface","title":"Interface","text":"<pre><code>type: picture-glance\ntitle: Carmona microphylla\nimage: ./local/bonsai.jpg\nentities:\n- entity: input_datetime.date_arrosage\n- entity: input_datetime.date_next_arrosage\n- entity: input_number.interval_arrosage\nentity: input_datetime.date_arrosage\n</code></pre> Vue du widget dans l'application"},{"location":"04-trajet/","title":"Trajet domicile/travail","text":"<p>Objectif : Es-tu bien arriv\u00e9 \u00e0 destination, \u00e0 quelle heure rentres-tu ?</p> <p>Envoyer une notification \u00e0 l'arriv\u00e9e sur mon lieu de travail et une autre lors du retour au domicile avec indication du temps de trajet estim\u00e9.</p>"},{"location":"04-trajet/#materiel-utilise","title":"Mat\u00e9riel utilis\u00e9","text":"<ul> <li>2 t\u00e9l\u00e9phones portables sur lesquels sont install\u00e9e l'application mobile Home assistant pour recevoir la notification et partager sa localisation.</li> </ul>"},{"location":"04-trajet/#mise-en-oeuvre","title":"Mise en oeuvre","text":"<p>2 zones d\u00e9finies au niveau de Home assistant :</p> <ul> <li>home : adresse du domicile</li> <li>travail : adresse du lieu de travail</li> </ul>"},{"location":"04-trajet/#estimation-du-temps-de-trajet-retour","title":"Estimation du temps de trajet retour","text":"<pre><code>sensor:\n- platform: waze_travel_time\nname: \"Vieux codeur ETT Home\"\norigin: device_tracker.pixel_2_xl_2\ndestination: zone.home\nregion: 'EU'\n</code></pre>"},{"location":"04-trajet/#notification-arrivee-travail","title":"Notification arriv\u00e9e travail","text":"<pre><code>automation:\n- id: vieux_codeur_travail\nalias: Vieux codeur est arriv\u00e9 \u00e0 Travail\ninitial_state: true\ntrigger:\n- platform: zone\nevent: enter\nzone: zone.travail\nentity_id: person.vieuxcodeur\ncondition:\n- condition: time\nafter: \"07:30:00\"\nbefore: \"09:30:00\"\nweekday:\n- mon\n- tue\n- wed\n- thu\n- fri\naction:\n- service: notify.mobile_vieillecodeuse\ndata:\nmessage: 'Vieux codeur est arriv\u00e9 \u00e0 Travail'\n</code></pre>"},{"location":"04-trajet/#notification-retour-a-la-maison","title":"Notification retour \u00e0 la maison","text":"<pre><code>automation:\n- id: vieuxcodeur_retour\nalias: Vieux codeur part de Travail\ninitial_state: true\ntrigger:\n- platform: zone\nevent: leave\nzone: zone.travail\nentity_id: person.mobile_app_pixel_2_xl\ncondition:\n- condition: time\nafter: \"18:00:00\"\nbefore: \"21:00:00\"\nweekday:\n- mon\n- tue\n- wed\n- thu\n- fri\naction:\n- service: notify.mobile_vieillecodeuse\ndata:\nmessage: \"Vieux codeur rentre du travail, arriv\u00e9e dans {{states.sensor.vieux_codeur_ett_home.state|round} minutes.\"\n</code></pre>"},{"location":"05-tv/","title":"TV non connect\u00e9e","text":"<p>Objectif : Connecter \u00e0 Home Assistant une t\u00e9l\u00e9vision non connect\u00e9e</p>"},{"location":"05-tv/#materiel-utilise","title":"Mat\u00e9riel utilis\u00e9","text":"<ul> <li>une t\u00e9l\u00e9vision non connect\u00e9e</li> <li>Google Chromecast (cl\u00e9 Hdmi wifi permettant de diffuser un contenu sur une t\u00e9l\u00e9vision depuis des applications mobiles comme Netflix ou Youtube)</li> <li>une t\u00e9l\u00e9commande universelle connect\u00e9e: Broadlink  RM mini.  </li> </ul>"},{"location":"05-tv/#mise-en-oeuvre","title":"Mise en oeuvre","text":""},{"location":"05-tv/#declaration-dun-capteur-onoff-pour-la-tv","title":"D\u00e9claration d'un capteur on/off pour la TV","text":"<p>Le chromecast, <code>media_player.salon</code>, est aliment\u00e9 quand la t\u00e9l\u00e9vision est allum\u00e9e et positionne le capteur <code>tv_template</code> a on. </p> <pre><code>sensor:\n- platform: template\nsensors:\ntv_template:\nunique_id: tv_template\nfriendly_name: 'TV Salon'\nvalue_template: \"{{ 'off' if is_state('media_player.salon', 'unavailable') else 'on' }}\"\nicon_template: \"{{ 'mdi:close-circle' if is_state('media_player.salon', 'unavailable') else 'mdi:monitor' }}\"   </code></pre>"},{"location":"05-tv/#script-permettant-dallumer-ou-deteindre-la-tv","title":"Script permettant d'allumer ou d'\u00e9teindre la TV","text":"<p>L'int\u00e9gration Broadlink RM mini se configure directement depuis l'interface de Home Assistant.</p> <p>Le RM mini, <code>remote.bro_remote</code>, envoi la commande power lors de l'ex\u00e9cution du script, et allume la t\u00e9l\u00e9vision. Cette commande a \u00e9t\u00e9 au pr\u00e9ablable enregist\u00e9e \u00e0 partir de la t\u00e9l\u00e9commande d'origine et stock\u00e9e dans le r\u00e9pertoire .storage de Home Assistant. </p> <pre><code>scripts:\ntv_onoff:\nalias: tv_on\nsequence:\n- service: remote.send_command\ndata:\nentity_id: remote.bro_remote\ndevice: tv\ncommand: power\nentity_id: remote.bro_remote\nmode: single\n</code></pre>"},{"location":"05-tv/#automatisations","title":"Automatisations","text":"<p>Il est maintenant possible de concevoir des automatisations \u00e0 partir de l'\u00e9tat de la TV (on/off) et du script permettant de l'allumer ou de l'\u00e9teindre.</p>"},{"location":"06-mode-nuit/","title":"Mode nuit","text":"<p>Objectif : Eteindre les appareils rest\u00e9s allum\u00e9s lors du couch\u00e9 en scannant un tag NFC</p>"},{"location":"06-mode-nuit/#materiel-utilise","title":"Mat\u00e9riel utilis\u00e9","text":"<ul> <li>1 badge NFC pouvant \u00eatre \u00e9crit par Home Assistant</li> <li>une t\u00e9l\u00e9commande universelle connect\u00e9e: Broadlink  RM mini.</li> <li>1 t\u00e9l\u00e9vision non connect\u00e9e </li> <li>1 barre de son Yamaha MusicCast</li> <li>3 ampoules de marque Wiz positionn\u00e9es dans le salon et la salle \u00e0 manger</li> </ul>"},{"location":"06-mode-nuit/#mise-en-oeuvre","title":"Mise en oeuvre","text":""},{"location":"06-mode-nuit/#lecture-du-badge-nfc","title":"Lecture du badge NFC","text":"<pre><code>- id: '1612460915835'\nalias: La balise nuit est analys\u00e9e\ndescription: ''\ntrigger:\n- platform: tag\ntag_id: d23152c3-01e7-48a7-b82b-ab989ba2c686\ncondition: []\naction:\n- service: script.sleep\ndata: {}\nmode: single\n</code></pre>"},{"location":"06-mode-nuit/#groupe-de-lampes","title":"Groupe de lampes","text":"<p>Le groupe permet d'agir sur une liste de lampes en une seule action.</p> <pre><code>light:\n- platform: group\nname: Lumi\u00e8res salon\nentities:\n- light.salon\n- light.salon2\n- light.salle_a_manger\n</code></pre>"},{"location":"06-mode-nuit/#script-eteignant-les-appareils","title":"Script \u00e9teignant les appareils","text":"<ul> <li> <p>Le <code>device</code> 42e5549cdbc8b0094de6a194ffcbf2bf correspond \u00e0 la barre de son.</p> </li> <li> <p>Le script tv_onoff permet d'allumer ou d'\u00e9teindre la TV.</p> </li> </ul> <pre><code>script:\nsleep:\nalias: sleep\nsequence:\n- service: light.turn_off\ndata: {}\nentity_id: light.lumieres_salon\n- service: media_player.turn_off\ndata: {}\ntarget:\ndevice_id: 42e5549cdbc8b0094de6a194ffcbf2bf\n- condition: state\nentity_id: sensor.tv_template\nstate: 'on'\n- service: script.tv_onoff\ndata: {}\nmode: single\nicon: mdi:sleep\n</code></pre>"},{"location":"07-chauffage/","title":"Gestion du chauffage","text":"<p>Objectif : Connecter \u00e0 Home Assistant une pompe \u00e0 chaleur non connect\u00e9e</p>"},{"location":"07-chauffage/#materiel-utilise","title":"Mat\u00e9riel utilis\u00e9","text":"<ul> <li>une sonde wifi pour r\u00e9cup\u00e9rer la temp\u00e9rature et le taux d'humidit\u00e9 de la pi\u00e8ce \u00e0 chauffer</li> <li>une pompe \u00e0 chaleur non connect\u00e9e \u00e9quip\u00e9e d'une t\u00e9l\u00e9commande infrarouge</li> <li>une t\u00e9l\u00e9commande universelle connect\u00e9e: Broadlink  RM mini.  </li> </ul>"},{"location":"07-chauffage/#mise-en-oeuvre","title":"Mise en oeuvre","text":""},{"location":"07-chauffage/#ajout-de-la-sonde-de-temperature","title":"Ajout de la sonde de temp\u00e9rature","text":"<p>La sonde utilis\u00e9e est une sonde  Shelly H&amp;T qui fonctionne sur le r\u00e9seau local en wifi, sans envoyer de donn\u00e9e sur un serveur distant.</p> <p>Une fois aliment\u00e9e, la sonde propose un r\u00e9seau wifi auquel il faut se connecter pour acc\u00e8der \u00e0 sa page de configutation (http://192.168.33.1). Cela permet de renseigner le SSID de son propre r\u00e9seau.  </p> <p>L'ajout dans Home Assistant se fait alors simplement avec l'int\u00e9gration Shelly, fournie par d\u00e9faut.</p>"},{"location":"07-chauffage/#declaration-de-la-pompe-a-chaleur","title":"D\u00e9claration de la pompe \u00e0 chaleur","text":"<p>La pompe a chaleur est ajout\u00e9e \u00e0 Home assistant via l'int\u00e9gration (custom) SmartIR</p> <pre><code>smartir:\nclimate:\n- platform: smartir\nname: Salon AC\nunique_id: saloon_ac\ndevice_code: 1263\ncontroller_data: remote.rmminisalon\ntemperature_sensor: sensor.shellyht_7020b3_temperature\nhumidity_sensor: sensor.shellyht_7020b3_humidity\n</code></pre> <p><code>temperature_sensor</code> et <code>humidity_sensor</code> correpondent aux capteurs de temp\u00e9rature et d'humidit\u00e9 de la sonde Shelly.</p> <p><code>device_code</code> correspond au mod\u00e8le de pompe \u00e0 chaleur utilis\u00e9e pour laquelle les diff\u00e9rents codes pouvant \u00eatre envoy\u00e9s par la t\u00e9l\u00e9commande infrarouge sont connus de <code>SmartIR</code>.</p> <p><code>controller_data</code> r\u00e9f\u00e9rence la t\u00e9l\u00e9commande universelle utilis\u00e9e (Broadlink RM mini) pour piloter la pompe \u00e0 chaleur.</p> <p>L'int\u00e9gration Broadlink RM mini se configure directement depuis l'interface de Home Assistant.</p>"},{"location":"07-chauffage/#automatisations","title":"Automatisations","text":"<p>Le chauffage est \u00e9teint si :</p> <ul> <li>la temp\u00e9rature de la pi\u00e8ce d\u00e9passe 21\u00b0 pendant 10 minutes,</li> <li>la pompe \u00e0 chaleur est en mode chauffage. </li> </ul> <p>Le seuil de 21 est positionn\u00e9 plus haut que la temp\u00e9rature demand\u00e9e \u00e0 la pompe \u00e0 chaleur pour \u00e9viter des arr\u00eats/red\u00e9marrages multiples. Ce seuil sera atteint par exemple par jour de beau temps o\u00f9 le soleil va faire monter la temp\u00e9rature au dela de la temp\u00e9rature souhait\u00e9e.</p> <pre><code>automation:\n- id: chauffageoff\nalias: chauffage off\ntrigger:\n- platform: numeric_state\nentity_id: sensor.shellyht_7020b3_temperature\nabove: 21\nfor:\nminutes: 10\ncondition:  - condition: state\nentity_id: climate.salon_ac\nstate: 'heat'\naction:\n- service: climate.turn_off\ndata: {}\ntarget:\nentity_id: climate.salon_ac\n</code></pre> <p>Le chauffage est allum\u00e9 si :</p> <ul> <li>la temp\u00e9rature de la pi\u00e8ce inf\u00e9rieure 19\u00b0 pendant 10 minutes,</li> <li>il est plus de 5 heure (matin)</li> </ul> <p>Cela permet de remettre le chauffage le matin, s'il a \u00e9t\u00e9 coup\u00e9 et que la temp\u00e9rature est trop basse.  </p> <pre><code>automation:\n- id: chauffageon\nalias: chauffage on\ntrigger:\n- platform: numeric_state\nentity_id: sensor.shellyht_7020b3_temperature\nbelow: 19\nfor:\nminutes: 10\ncondition:\n- condition: and\nconditions:\n- condition: time\nafter: '05:00:00'\naction:\n- service: climate.turn_on\ndata: {}\ntarget:\nentity_id: climate.salon_ac\n</code></pre>"}]}