{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Home assistant Home Assistant est un logiciel domotique open source que j'utilise afin de rendre ma maison \"intelligente\". Je vais vous pr\u00e9senter les principaux sc\u00e9narios d'automatisation que j'utilise au quotidien. Automatisations L'objectif est de mettre en place des actions automatiques en r\u00e9ponse \u00e0 des \u00e9v\u00e9nements survenant au sein de la maison. Allumer des lumi\u00e8res au r\u00e9veil Notification de connexion Rappel arrosage de mon bonsai Trajet domicile/travail Mes sources d'inspiration The Anchorage House Home Assistant Configuration Isabella Gross Alstr\u00f6m Home Assistant Configuration","title":"Home assistant"},{"location":"#home-assistant","text":"Home Assistant est un logiciel domotique open source que j'utilise afin de rendre ma maison \"intelligente\". Je vais vous pr\u00e9senter les principaux sc\u00e9narios d'automatisation que j'utilise au quotidien.","title":"Home assistant"},{"location":"#automatisations","text":"L'objectif est de mettre en place des actions automatiques en r\u00e9ponse \u00e0 des \u00e9v\u00e9nements survenant au sein de la maison. Allumer des lumi\u00e8res au r\u00e9veil Notification de connexion Rappel arrosage de mon bonsai Trajet domicile/travail","title":"Automatisations"},{"location":"#mes-sources-dinspiration","text":"The Anchorage House Home Assistant Configuration Isabella Gross Alstr\u00f6m Home Assistant Configuration","title":"Mes sources d'inspiration"},{"location":"01-reveil/","text":"R\u00e9veil Objectif Allumer 2 lampes \u00e0 l'heure du r\u00e9veil. Mat\u00e9riel utilis\u00e9 2 ampoules de marque Wiz positionn\u00e9es dans le salon et la salle \u00e0 manger 1 t\u00e9l\u00e9phone portable sur lequel est install\u00e9e l'application mobile Home assistant pour r\u00e9cup\u00e9rer l'heure de la prochaine alarme (heure de r\u00e9veil). Mise en oeuvre Les ampoules de marque Wiz ne sont actuellement pas reconnues par Home Assitant, mais sont int\u00e9gr\u00e9es dans d'autres solutions. J'ai utilis\u00e9 l'int\u00e9gration Home Assistant/SmartThings pour contourner le probl\u00e8me. La solution est loin d'\u00eatre id\u00e9ale puisqu'il faut passer par un serveur distant pour effectuer une action sur une ampoule locale. Cela pose des probl\u00e8mes de confidentialit\u00e9, d'ind\u00e9pendance vis \u00e0 vis d'un service externe (qui pourrait s'arr\u00eater ou devenir payant), mais aussi par rapport \u00e0 la latence que cela peut induire. Script r\u00e9veil Permet d'allumer les ampoules et de r\u00e9gler puissance et temp\u00e9rature. scripts : reveil : alias : reveil sequence : - service : light.turn_on data : brightness : 80 color_temp : 1000000 entity_id : light.salle_a_manger - service : light.turn_on data : {} entity_id : light.salon mode : single icon : mdi:alarm Automation L'automation se base sur l'heure de la prochaine alarme remont\u00e9e par l'application mobile : sensor.pixel_2_xl_next_alarm . Le script reveil est appel\u00e9 quand l'heure de reveil est atteinte si le mode vacance n'a pas \u00e9t\u00e9 activ\u00e9. automation : - id : lumierereveil alias : allumer lumi\u00e8res au r\u00e9veil trigger : - platform : template value_template : > {{now().strftime(\"%a %h %d %H:%M %Z %Y\") == (((state_attr('sensor.pixel_2_xl_next_alarm', 'Time in Milliseconds') | int / 1000) + 0*60 ) | timestamp_custom('%a %h %d %H:%M %Z %Y'))}} condition : - condition : state entity_id : input_boolean.mode_vacance state : 'off' action : - service : script.reveil","title":"R\u00e9veil"},{"location":"01-reveil/#reveil","text":"Objectif Allumer 2 lampes \u00e0 l'heure du r\u00e9veil.","title":"R\u00e9veil"},{"location":"01-reveil/#materiel-utilise","text":"2 ampoules de marque Wiz positionn\u00e9es dans le salon et la salle \u00e0 manger 1 t\u00e9l\u00e9phone portable sur lequel est install\u00e9e l'application mobile Home assistant pour r\u00e9cup\u00e9rer l'heure de la prochaine alarme (heure de r\u00e9veil).","title":"Mat\u00e9riel utilis\u00e9"},{"location":"01-reveil/#mise-en-oeuvre","text":"Les ampoules de marque Wiz ne sont actuellement pas reconnues par Home Assitant, mais sont int\u00e9gr\u00e9es dans d'autres solutions. J'ai utilis\u00e9 l'int\u00e9gration Home Assistant/SmartThings pour contourner le probl\u00e8me. La solution est loin d'\u00eatre id\u00e9ale puisqu'il faut passer par un serveur distant pour effectuer une action sur une ampoule locale. Cela pose des probl\u00e8mes de confidentialit\u00e9, d'ind\u00e9pendance vis \u00e0 vis d'un service externe (qui pourrait s'arr\u00eater ou devenir payant), mais aussi par rapport \u00e0 la latence que cela peut induire.","title":"Mise en oeuvre"},{"location":"01-reveil/#script-reveil","text":"Permet d'allumer les ampoules et de r\u00e9gler puissance et temp\u00e9rature. scripts : reveil : alias : reveil sequence : - service : light.turn_on data : brightness : 80 color_temp : 1000000 entity_id : light.salle_a_manger - service : light.turn_on data : {} entity_id : light.salon mode : single icon : mdi:alarm","title":"Script r\u00e9veil"},{"location":"01-reveil/#automation","text":"L'automation se base sur l'heure de la prochaine alarme remont\u00e9e par l'application mobile : sensor.pixel_2_xl_next_alarm . Le script reveil est appel\u00e9 quand l'heure de reveil est atteinte si le mode vacance n'a pas \u00e9t\u00e9 activ\u00e9. automation : - id : lumierereveil alias : allumer lumi\u00e8res au r\u00e9veil trigger : - platform : template value_template : > {{now().strftime(\"%a %h %d %H:%M %Z %Y\") == (((state_attr('sensor.pixel_2_xl_next_alarm', 'Time in Milliseconds') | int / 1000) + 0*60 ) | timestamp_custom('%a %h %d %H:%M %Z %Y'))}} condition : - condition : state entity_id : input_boolean.mode_vacance state : 'off' action : - service : script.reveil","title":"Automation"},{"location":"02-ssh-login-notification/","text":"Notification de connexion Objectif Envoyer une notification lors d'une connexion en ssh sur mon serveur NAS. Mat\u00e9riel utilis\u00e9 1 serveur NAS permettant la connexion distante par ssh 1 t\u00e9l\u00e9phone portable sur lequel est install\u00e9e l'application mobile Home assistant pour recevoir la notification. Mise en oeuvre Lors d'une connexion ssh les commandes pr\u00e9sentes dans le fichier /etc/ssh/sshrc sont ex\u00e9cut\u00e9es. En ajoutant les lignes de commandes suivantes il est possible d'appeler un WEBHOOK au niveau de Home Assistant. sshrc #!/bin/bash ip = $( echo \" $SSH_CONNECTION \" | cut -d \" \" -f 1 ) hs = $( hostname ) hostIP = \" $( ip address show dev eth0 | grep \"inet \" | head --lines = 1 | cut --delimiter = ' ' --fields = 6 | cut --delimiter = '/' --fields = 1 ) \" logger -t ssh-wrapper \" $USER \" login from \" $ip \" curl --header \"Content-Type: application/json\" \\ --request POST \\ --data \\ '{\"topic\": \"' \" $hs \" '\", \"host\": \"' \" $hs \" '\", \"hostIP\": \"' \" $hostIP \" '\", \"user\": \"' \" $USER \" '\", \"from\": \"' \" $ip \" '\", \"message\": \"' \" $USER @ $hs just logged in from $ip \" '\"}' \\ http://localhost:8123/api/webhook/MY-SSH-WEBHOOK La derni\u00e8re ligne doit \u00eatre adapt\u00e9e avec l'adresse de votre instance Home Assistant. Dans mon cas, elle est situ\u00e9e sur la m\u00eame machine. Traitement du WEBHOOK A la r\u00e9ception du WEBHOOK, le sensor ssh_login prend la valeur du message envoy\u00e9 (bob@nas just logged in from 192.168.1.2 par exemple). Au changement de valeur du sensor ssh_login, le service de notification est appel\u00e9 avec le message stock\u00e9 sur le sensor. automation : - id : ssh_login_notify alias : notify nas ssh login trigger : - platform : state entity_id : sensor.ssh_login action : service : notify.mobile_app_pixel_2_xl data : message : '{{ states.sensor.ssh_login.state }}' template : - trigger : - platform : webhook webhook_id : MY-SSH-WEBHOOK sensor : - name : \"ssh_login\" state : \"{{ trigger.json.message }}\"","title":"Notification de connexion"},{"location":"02-ssh-login-notification/#notification-de-connexion","text":"Objectif Envoyer une notification lors d'une connexion en ssh sur mon serveur NAS.","title":"Notification de connexion"},{"location":"02-ssh-login-notification/#materiel-utilise","text":"1 serveur NAS permettant la connexion distante par ssh 1 t\u00e9l\u00e9phone portable sur lequel est install\u00e9e l'application mobile Home assistant pour recevoir la notification.","title":"Mat\u00e9riel utilis\u00e9"},{"location":"02-ssh-login-notification/#mise-en-oeuvre","text":"Lors d'une connexion ssh les commandes pr\u00e9sentes dans le fichier /etc/ssh/sshrc sont ex\u00e9cut\u00e9es. En ajoutant les lignes de commandes suivantes il est possible d'appeler un WEBHOOK au niveau de Home Assistant.","title":"Mise en oeuvre"},{"location":"02-ssh-login-notification/#sshrc","text":"#!/bin/bash ip = $( echo \" $SSH_CONNECTION \" | cut -d \" \" -f 1 ) hs = $( hostname ) hostIP = \" $( ip address show dev eth0 | grep \"inet \" | head --lines = 1 | cut --delimiter = ' ' --fields = 6 | cut --delimiter = '/' --fields = 1 ) \" logger -t ssh-wrapper \" $USER \" login from \" $ip \" curl --header \"Content-Type: application/json\" \\ --request POST \\ --data \\ '{\"topic\": \"' \" $hs \" '\", \"host\": \"' \" $hs \" '\", \"hostIP\": \"' \" $hostIP \" '\", \"user\": \"' \" $USER \" '\", \"from\": \"' \" $ip \" '\", \"message\": \"' \" $USER @ $hs just logged in from $ip \" '\"}' \\ http://localhost:8123/api/webhook/MY-SSH-WEBHOOK La derni\u00e8re ligne doit \u00eatre adapt\u00e9e avec l'adresse de votre instance Home Assistant. Dans mon cas, elle est situ\u00e9e sur la m\u00eame machine.","title":"sshrc"},{"location":"02-ssh-login-notification/#traitement-du-webhook","text":"A la r\u00e9ception du WEBHOOK, le sensor ssh_login prend la valeur du message envoy\u00e9 (bob@nas just logged in from 192.168.1.2 par exemple). Au changement de valeur du sensor ssh_login, le service de notification est appel\u00e9 avec le message stock\u00e9 sur le sensor. automation : - id : ssh_login_notify alias : notify nas ssh login trigger : - platform : state entity_id : sensor.ssh_login action : service : notify.mobile_app_pixel_2_xl data : message : '{{ states.sensor.ssh_login.state }}' template : - trigger : - platform : webhook webhook_id : MY-SSH-WEBHOOK sensor : - name : \"ssh_login\" state : \"{{ trigger.json.message }}\"","title":"Traitement du WEBHOOK"},{"location":"03-bonsai/","text":"Arrosage Objectif Se rappeler de la date du dernier arrosage de mon bonsai en scannant un tag NFC pr\u00e9sent dans la soucoupe et envoyer une notification de rappel quand la date de prochain arrosage est atteinte. Mat\u00e9riel utilis\u00e9 1 badge NFC pouvant \u00eatre \u00e9crit par Home Assistant 1 t\u00e9l\u00e9phone portable sur lequel est install\u00e9e l'application mobile Home assistant pour recevoir la notification. Mise en oeuvre Param\u00e9trage du d\u00e9lai entre deux arrosages input_number : interval_arrosage : name : Interval en jour entre 2 arrosages initial : 3 min : 1 max : 7 step : 1 mode : box Date dernier/prochain arrosage input_datetime : date_arrosage : name : date dernier arrosage has_date : true has_time : false date_next_arrosage : name : date prochain arrosage has_date : true has_time : false Lecture du badge NFC automation : - id : 'update_date_arrosage' alias : La balise bonsai est analys\u00e9e description : '' trigger : - platform : tag tag_id : 2fbab09d-6347-4042-8165-1a35c0877a7f condition : [] action : - service : input_datetime.set_datetime data : datetime : \"{{ now().strftime('%Y-%m-%d') }}\" entity_id : input_datetime.date_arrosage - service : input_datetime.set_datetime data : datetime : \"{{ (now() + timedelta(days=states('input_number.interval_arrosage')| int + 1)).strftime('%Y-%m-%d') }}\" entity_id : input_datetime.date_next_arrosage mode : single Notification automation : - id : 'rappelArrosage' alias : rappel arrosage Bonsai trigger : - platform : time at : \"17:00:00\" condition : - condition : state entity_id : input_boolean.mode_vacance state : 'off' - condition : template value_template : \"{{ states('sensor.date') > states('input_datetime.date_next_arrosage') }}\" action : - service : notify.mobile_app_pixel_2_xl data : message : 'Il est temps d' arroser le Bonsai' - service : input_datetime.set_datetime data : datetime : \"{{ (now() + timedelta(days=1)).strftime('%Y-%m-%d') }}\" entity_id : input_datetime.date_next_arrosage Interface type : picture-glance title : Carmona microphylla image : ./local/bonsai.jpg entities : - entity : input_datetime.date_arrosage - entity : input_datetime.date_next_arrosage - entity : input_number.interval_arrosage entity : input_datetime.date_arrosage Vue du widget dans l'application","title":"Arrosage"},{"location":"03-bonsai/#arrosage","text":"Objectif Se rappeler de la date du dernier arrosage de mon bonsai en scannant un tag NFC pr\u00e9sent dans la soucoupe et envoyer une notification de rappel quand la date de prochain arrosage est atteinte.","title":"Arrosage"},{"location":"03-bonsai/#materiel-utilise","text":"1 badge NFC pouvant \u00eatre \u00e9crit par Home Assistant 1 t\u00e9l\u00e9phone portable sur lequel est install\u00e9e l'application mobile Home assistant pour recevoir la notification.","title":"Mat\u00e9riel utilis\u00e9"},{"location":"03-bonsai/#mise-en-oeuvre","text":"","title":"Mise en oeuvre"},{"location":"03-bonsai/#parametrage-du-delai-entre-deux-arrosages","text":"input_number : interval_arrosage : name : Interval en jour entre 2 arrosages initial : 3 min : 1 max : 7 step : 1 mode : box","title":"Param\u00e9trage du d\u00e9lai entre deux arrosages"},{"location":"03-bonsai/#date-dernierprochain-arrosage","text":"input_datetime : date_arrosage : name : date dernier arrosage has_date : true has_time : false date_next_arrosage : name : date prochain arrosage has_date : true has_time : false","title":"Date dernier/prochain arrosage"},{"location":"03-bonsai/#lecture-du-badge-nfc","text":"automation : - id : 'update_date_arrosage' alias : La balise bonsai est analys\u00e9e description : '' trigger : - platform : tag tag_id : 2fbab09d-6347-4042-8165-1a35c0877a7f condition : [] action : - service : input_datetime.set_datetime data : datetime : \"{{ now().strftime('%Y-%m-%d') }}\" entity_id : input_datetime.date_arrosage - service : input_datetime.set_datetime data : datetime : \"{{ (now() + timedelta(days=states('input_number.interval_arrosage')| int + 1)).strftime('%Y-%m-%d') }}\" entity_id : input_datetime.date_next_arrosage mode : single","title":"Lecture du badge NFC"},{"location":"03-bonsai/#notification","text":"automation : - id : 'rappelArrosage' alias : rappel arrosage Bonsai trigger : - platform : time at : \"17:00:00\" condition : - condition : state entity_id : input_boolean.mode_vacance state : 'off' - condition : template value_template : \"{{ states('sensor.date') > states('input_datetime.date_next_arrosage') }}\" action : - service : notify.mobile_app_pixel_2_xl data : message : 'Il est temps d' arroser le Bonsai' - service : input_datetime.set_datetime data : datetime : \"{{ (now() + timedelta(days=1)).strftime('%Y-%m-%d') }}\" entity_id : input_datetime.date_next_arrosage","title":"Notification"},{"location":"03-bonsai/#interface","text":"type : picture-glance title : Carmona microphylla image : ./local/bonsai.jpg entities : - entity : input_datetime.date_arrosage - entity : input_datetime.date_next_arrosage - entity : input_number.interval_arrosage entity : input_datetime.date_arrosage Vue du widget dans l'application","title":"Interface"},{"location":"04-trajet/","text":"Trajet domicile/travail Objectif : Es-tu bien arriv\u00e9 \u00e0 destination, \u00e0 quelle heure rentres-tu ? Envoyer une notification \u00e0 l'arriv\u00e9e sur mon lieu de travail et une autre lors du retour au domicile avec indication du temps de trajet estim\u00e9. Mat\u00e9riel utilis\u00e9 2 t\u00e9l\u00e9phones portables sur lesquels sont install\u00e9e l'application mobile Home assistant pour recevoir la notification et partager sa localisation. Mise en oeuvre 2 zones d\u00e9finies au niveau de Home assistant : home : adresse du domicile travail : adresse du lieu de travail Estimation du temps de trajet retour sensor : - platform : waze_travel_time name : \"Vieux codeur ETT Home\" origin : device_tracker.pixel_2_xl_2 destination : zone.home region : 'EU' Notification arriv\u00e9e travail automation : - id : vieux_codeur_travail alias : Vieux codeur est arriv\u00e9 \u00e0 Travail initial_state : true trigger : - platform : zone event : enter zone : zone.travail entity_id : person.vieuxcodeur condition : - condition : time after : \"07:30:00\" before : \"09:30:00\" weekday : - mon - tue - wed - thu - fri action : - service : notify.mobile_vieillecodeuse data : message : 'Vieux codeur est arriv\u00e9 \u00e0 Travail' Notification retour \u00e0 la maison automation : - id : vieuxcodeur_retour alias : Vieux codeur part de Travail initial_state : true trigger : - platform : zone event : leave zone : zone.travail entity_id : person.mobile_app_pixel_2_xl condition : - condition : time after : \"18:00:00\" before : \"21:00:00\" weekday : - mon - tue - wed - thu - fri action : - service : notify.mobile_vieillecodeuse data : message : \"Vieux codeur rentre du travail, arriv\u00e9e dans {{states.sensor.vieux_codeur_ett_home.state|round} minutes.\"","title":"Trajet domicile/travail"},{"location":"04-trajet/#trajet-domiciletravail","text":"Objectif : Es-tu bien arriv\u00e9 \u00e0 destination, \u00e0 quelle heure rentres-tu ? Envoyer une notification \u00e0 l'arriv\u00e9e sur mon lieu de travail et une autre lors du retour au domicile avec indication du temps de trajet estim\u00e9.","title":"Trajet domicile/travail"},{"location":"04-trajet/#materiel-utilise","text":"2 t\u00e9l\u00e9phones portables sur lesquels sont install\u00e9e l'application mobile Home assistant pour recevoir la notification et partager sa localisation.","title":"Mat\u00e9riel utilis\u00e9"},{"location":"04-trajet/#mise-en-oeuvre","text":"2 zones d\u00e9finies au niveau de Home assistant : home : adresse du domicile travail : adresse du lieu de travail","title":"Mise en oeuvre"},{"location":"04-trajet/#estimation-du-temps-de-trajet-retour","text":"sensor : - platform : waze_travel_time name : \"Vieux codeur ETT Home\" origin : device_tracker.pixel_2_xl_2 destination : zone.home region : 'EU'","title":"Estimation du temps de trajet retour"},{"location":"04-trajet/#notification-arrivee-travail","text":"automation : - id : vieux_codeur_travail alias : Vieux codeur est arriv\u00e9 \u00e0 Travail initial_state : true trigger : - platform : zone event : enter zone : zone.travail entity_id : person.vieuxcodeur condition : - condition : time after : \"07:30:00\" before : \"09:30:00\" weekday : - mon - tue - wed - thu - fri action : - service : notify.mobile_vieillecodeuse data : message : 'Vieux codeur est arriv\u00e9 \u00e0 Travail'","title":"Notification arriv\u00e9e travail"},{"location":"04-trajet/#notification-retour-a-la-maison","text":"automation : - id : vieuxcodeur_retour alias : Vieux codeur part de Travail initial_state : true trigger : - platform : zone event : leave zone : zone.travail entity_id : person.mobile_app_pixel_2_xl condition : - condition : time after : \"18:00:00\" before : \"21:00:00\" weekday : - mon - tue - wed - thu - fri action : - service : notify.mobile_vieillecodeuse data : message : \"Vieux codeur rentre du travail, arriv\u00e9e dans {{states.sensor.vieux_codeur_ett_home.state|round} minutes.\"","title":"Notification retour \u00e0 la maison"}]}